name: SEO Audit

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1' # every Monday at 06:00 UTC

jobs:
  run-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ensure reports dir
        run: mkdir -p reports

      - name: Run seo_audit.py
        run: |
          python seo_audit.py --output=reports/seo_report --formats=csv,json --root=. --verbose

      - name: List reports
        run: ls -la reports || true

      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: seo-reports
          path: reports

      - name: Comment summary on PR (only on PR runs)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './reports/seo_report.json';
            let body = '### SEO Audit summary\n\n';
            if (fs.existsSync(path)) {
              try {
                const data = JSON.parse(fs.readFileSync(path, 'utf8'));
                const pagesCount = Array.isArray(data.pages) ? data.pages.length : 'n/a';
                let jsonLdCount = 0;
                if (Array.isArray(data.pages)) {
                  for (const p of data.pages) {
                    if (p.meta && typeof p.meta.json_ld_count === 'number') jsonLdCount += p.meta.json_ld_count;
                  }
                }
                body += `- Pages scanned: ${pagesCount}\n`;
                body += `- JSON-LD blocks found (sum): ${jsonLdCount}\n`;
                const artifactUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}/artifacts`;
                body += `- Artifacts: [seo-reports.zip](${artifactUrl})\n\n`;
                body += 'If you want specific suggestions (titles/descriptions, hreflang fixes, or image checks) I can generate them in a follow-up.\n';
              } catch (e) {
                body += `- Failed to parse report: ${e.message}\n`;
              }
            } else {
              body += '- Report not found in workspace.\n';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
